name: Reusable Backend Deploy (Lightsail)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (staging|production)"
        type: string
        required: true
      update_type:
        description: "Update type (code|config|ssl)"
        type: string
        required: false
        default: code
      runSeeds:
        description: "Run seeds after migrations (true|false)"
        type: string
        required: false
        default: 'false'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    concurrency:
      group: be-deploy-${{ inputs.environment }}
      cancel-in-progress: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy code to Lightsail (backend)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          source: "."
          target: "/tmp/backend"
          strip_components: 1

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            set -e
            echo "=== BACKEND DEPLOY (${{ inputs.environment }}) ==="
            APP_HOME="/opt/backend"
            BACKEND_DOMAIN="${{ secrets.BACKEND_DOMAIN }}"
            FRONTEND_DOMAIN="${{ secrets.FRONTEND_DOMAIN }}"
            STATIC_IP=$(curl -s http://checkip.amazonaws.com/)

            # Move files into place
            sudo mkdir -p $APP_HOME
            if [ -d "/tmp/backend" ]; then
              sudo rm -rf $APP_HOME/*
              sudo cp -r /tmp/backend/* $APP_HOME/
              sudo chown -R "$USER":"$USER" $APP_HOME
              sudo rm -rf /tmp/backend
            fi

            cd $APP_HOME

            # Always update nginx config with actual domain and IP
            sudo sed -i "s/yourdomain.com/${BACKEND_DOMAIN}/g" nginx/conf.d/backend.conf || true
            sudo sed -i "s/server_name _/server_name ${BACKEND_DOMAIN} ${STATIC_IP}/g" nginx/conf.d/backend.conf || true

            if [ "${{ inputs.update_type }}" = "code" ]; then
              # Stop system Nginx
              sudo systemctl stop nginx || true
              # Restart stack cleanly
              sg docker -c "docker-compose -f docker-compose.prod.yml down || true"

              # Write .env fresh
              printf "%s\n" \
              "NODE_ENV=production" \
              "APP_PORT=3000" \
              "APP_NAME=${{ secrets.APP_NAME }}" \
              "API_PREFIX=api" \
              "APP_FALLBACK_LANGUAGE=en" \
              "APP_HEADER_LANGUAGE=x-custom-lang" \
              "FRONTEND_DOMAIN=${FRONTEND_DOMAIN}" \
              "BACKEND_DOMAIN=${BACKEND_DOMAIN}" \
              "DATABASE_TYPE=postgres" \
              "DATABASE_HOST=postgres" \
              "DATABASE_PORT=5432" \
              "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME || secrets.POSTGRES_USER }}" \
              "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" \
              "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" \
              "DATABASE_SYNCHRONIZE=false" \
              "DATABASE_MAX_CONNECTIONS=100" \
              "DATABASE_SSL_ENABLED=false" \
              "DATABASE_REJECT_UNAUTHORIZED=false" \
              "DATABASE_CA=" \
              "DATABASE_KEY=" \
              "DATABASE_CERT=" \
              "DATABASE_URL=" \
              "FILE_DRIVER=${{ secrets.FILE_DRIVER }}" \
              "ACCESS_KEY_ID=${{ secrets.S3AWS_ACCESS_KEY_ID }}" \
              "SECRET_ACCESS_KEY=${{ secrets.S3AWS_SECRET_ACCESS_KEY }}" \
              "AWS_S3_REGION=${{ secrets.S3AWS_REGION }}" \
              "AWS_DEFAULT_S3_BUCKET=${{ secrets.S3AWS_DEFAULT_S3_BUCKET }}" \
              "AZURE_STORAGE_ACCOUNT_NAME=${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              "AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
              "AZURE_CONTAINER_NAME=${{ secrets.AZURE_CONTAINER_NAME }}" \
              "AZURE_BLOB_SAS_EXPIRY_SECONDS=${{ secrets.AZURE_BLOB_SAS_EXPIRY_SECONDS }}" \
              "AZURE_BLOB_PUBLIC_BASE_URL=${{ secrets.AZURE_BLOB_PUBLIC_BASE_URL }}" \
              "AUTH_JWT_SECRET=secret" \
              "AUTH_JWT_TOKEN_EXPIRES_IN=15m" \
              "AUTH_REFRESH_SECRET=secret_for_refresh" \
              "AUTH_REFRESH_TOKEN_EXPIRES_IN=3650d" \
              "AUTH_FORGOT_SECRET=secret_for_forgot" \
              "AUTH_FORGOT_TOKEN_EXPIRES_IN=30m" \
              "AUTH_CONFIRM_EMAIL_SECRET=secret_for_confirm_email" \
              "AUTH_CONFIRM_EMAIL_TOKEN_EXPIRES_IN=1d" \
              "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}" \
              "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" \
              "FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}" \
              "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
              "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              "APPLE_APP_AUDIENCE=[]" \
              "WORKER_HOST=redis://redis:6379/1" \
              "REDIS_ENABLED=false" \
              "REDIS_HOST=redis" \
              "REDIS_PORT=6379" \
              "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" \
              "REDIS_DB=0" \
              "REDIS_TTL=3600" \
              "ZOOM_OAUTH_CLIENT_ID=${{ secrets.ZOOM_OAUTH_CLIENT_ID }}" \
              "ZOOM_OAUTH_CLIENT_SECRET=${{ secrets.ZOOM_OAUTH_CLIENT_SECRET }}" \
              "ZOOM_OAUTH_REDIRECT_URI=${{ secrets.ZOOM_OAUTH_REDIRECT_URI }}" \
              "OPENEXCHANGERATES_APP_ID=${{ secrets.OPENEXCHANGERATES_APP_ID }}" \
              | sudo tee .env >/dev/null

              # Rebuild and start core services
              sg docker -c "docker-compose -f docker-compose.prod.yml build --no-cache app"
              sg docker -c "docker-compose -f docker-compose.prod.yml up -d postgres redis app"
              sleep 20
            fi

            if [ "${{ inputs.update_type }}" = "config" ]; then
              # Write env and restart app
              printf "%s\n" \
              "NODE_ENV=production" \
              "APP_PORT=3000" \
              "APP_NAME=${{ secrets.APP_NAME }}" \
              "API_PREFIX=api" \
              "APP_FALLBACK_LANGUAGE=en" \
              "APP_HEADER_LANGUAGE=x-custom-lang" \
              "FRONTEND_DOMAIN=${FRONTEND_DOMAIN}" \
              "BACKEND_DOMAIN=${BACKEND_DOMAIN}" \
              "DATABASE_TYPE=postgres" \
              "DATABASE_HOST=postgres" \
              "DATABASE_PORT=5432" \
              "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME || secrets.POSTGRES_USER }}" \
              "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" \
              "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" \
              "DATABASE_SYNCHRONIZE=false" \
              "DATABASE_MAX_CONNECTIONS=100" \
              "DATABASE_SSL_ENABLED=false" \
              "DATABASE_REJECT_UNAUTHORIZED=false" \
              "DATABASE_CA=" \
              "DATABASE_KEY=" \
              "DATABASE_CERT=" \
              "DATABASE_URL=" \
              "FILE_DRIVER=${{ secrets.FILE_DRIVER }}" \
              "ACCESS_KEY_ID=${{ secrets.S3AWS_ACCESS_KEY_ID }}" \
              "SECRET_ACCESS_KEY=${{ secrets.S3AWS_SECRET_ACCESS_KEY }}" \
              "AWS_S3_REGION=${{ secrets.S3AWS_REGION }}" \
              "AWS_DEFAULT_S3_BUCKET=${{ secrets.S3AWS_DEFAULT_S3_BUCKET }}" \
              "AZURE_STORAGE_ACCOUNT_NAME=${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              "AZURE_STORAGE_ACCOUNT_KEY=${{ secrets.AZURE_STORAGE_ACCOUNT_KEY }}" \
              "AZURE_CONTAINER_NAME=${{ secrets.AZURE_CONTAINER_NAME }}" \
              "AZURE_BLOB_SAS_EXPIRY_SECONDS=${{ secrets.AZURE_BLOB_SAS_EXPIRY_SECONDS }}" \
              "AZURE_BLOB_PUBLIC_BASE_URL=${{ secrets.AZURE_BLOB_PUBLIC_BASE_URL }}" \
              "AUTH_JWT_SECRET=secret" \
              "AUTH_JWT_TOKEN_EXPIRES_IN=15m" \
              "AUTH_REFRESH_SECRET=secret_for_refresh" \
              "AUTH_REFRESH_TOKEN_EXPIRES_IN=3650d" \
              "AUTH_FORGOT_SECRET=secret_for_forgot" \
              "AUTH_FORGOT_TOKEN_EXPIRES_IN=30m" \
              "AUTH_CONFIRM_EMAIL_SECRET=secret_for_confirm_email" \
              "AUTH_CONFIRM_EMAIL_TOKEN_EXPIRES_IN=1d" \
              "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}" \
              "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" \
              "FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}" \
              "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" \
              "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              "APPLE_APP_AUDIENCE=[]" \
              "WORKER_HOST=redis://redis:6379/1" \
              "REDIS_ENABLED=false" \
              "REDIS_HOST=redis" \
              "REDIS_PORT=6379" \
              "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" \
              "REDIS_DB=0" \
              "REDIS_TTL=3600" \
              "ZOOM_OAUTH_CLIENT_ID=${{ secrets.ZOOM_OAUTH_CLIENT_ID }}" \
              "ZOOM_OAUTH_CLIENT_SECRET=${{ secrets.ZOOM_OAUTH_CLIENT_SECRET }}" \
              "ZOOM_OAUTH_REDIRECT_URI=${{ secrets.ZOOM_OAUTH_REDIRECT_URI }}" \
              "OPENEXCHANGERATES_APP_ID=${{ secrets.OPENEXCHANGERATES_APP_ID }}" \
              | sudo tee .env >/dev/null

              sg docker -c "docker-compose -f docker-compose.prod.yml restart app"
              sg docker -c "docker-compose -f docker-compose.prod.yml up -d --force-recreate nginx"
            fi

            if [ "${{ inputs.update_type }}" = "ssl" ]; then
              sg docker -c "docker-compose -f docker-compose.prod.yml stop nginx"
              sudo certbot renew --standalone --non-interactive || sudo certbot certonly --standalone -d ${BACKEND_DOMAIN} --non-interactive --agree-tos --email ${{ secrets.EMAIL }}
              sg docker -c "docker-compose -f docker-compose.prod.yml start nginx"
            fi

      - name: Run migrations
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            for i in $(seq 1 30); do
              status=$(docker inspect --format='{{json .State.Health.Status}}' backend_app 2>/dev/null | tr -d '"' || echo 'starting')
              if [ "$status" = "healthy" ]; then echo "backend_app healthy"; break; fi
              echo "backend_app status: $status (retry $i)"; sleep 2;
            done
            docker exec backend_app sh -lc 'npx typeorm --dataSource=dist/database/data-source.js migration:run | cat'

      - name: Optionally run seeds
        if: ${{ inputs.runSeeds == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            docker exec backend_app sh -lc 'node dist/database/seeds/relational/run-seed.js | cat'


